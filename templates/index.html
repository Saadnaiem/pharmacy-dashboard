<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pharmacy Sales Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1><span class="h1-icon">ğŸ’Š</span>Pharmacy Sales Dashboard</h1>
    <form method="POST">
        <div class="sidebar-modern">
            <div class="sidebar-header">
                <span class="sidebar-logo">ğŸ’Š</span>
                <span class="sidebar-title">Filters</span>
            </div>
            <div class="filter-group" id="filter-year">
                <div class="filter-header" onclick="toggleFilter('filter-year')"><span class="filter-icon">ğŸ“…</span> <span>Year</span></div>
                <div class="filter-body">
                    <select name="years" multiple>
                        <option value="all" {% if selected_years|length == years|length %}selected{% endif %}>All</option>
                        {% for y in years %}
                        <option value="{{y}}" {% if y in selected_years %}selected{% endif %}>{{y}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-group" id="filter-month">
                <div class="filter-header" onclick="toggleFilter('filter-month')"><span class="filter-icon">ğŸ—“ï¸</span> <span>Month</span></div>
                <div class="filter-body">
                    <select name="months" multiple>
                        <option value="all" {% if selected_months|length == months|length %}selected{% endif %}>All</option>
                        {% for m, m_num in month_map.items() %}
                        <option value="{{m_num}}" {% if m_num in selected_months %}selected{% endif %}>{{m}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-group" id="filter-location">
                <div class="filter-header" onclick="toggleFilter('filter-location')"><span class="filter-icon">ğŸ“</span> <span>Location</span></div>
                <div class="filter-body">
                    <select name="locations" multiple>
                        <option value="all" {% if selected_locations|length == locations|length %}selected{% endif %}>All</option>
                        {% for l in locations %}
                        <option value="{{l}}" {% if l in selected_locations %}selected{% endif %}>{{l}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="filter-group" id="filter-pharmacist">
                <div class="filter-header" onclick="toggleFilter('filter-pharmacist')"><span class="filter-icon">ğŸ‘¨â€âš•ï¸</span> <span>Pharmacist</span></div>
                <div class="filter-body">
                    <select name="pharmacists" multiple>
                        <option value="all" {% if selected_pharmacists|length == pharmacists|length %}selected{% endif %}>All</option>
                        {% for p in pharmacists %}
                        <option value="{{p}}" {% if p in selected_pharmacists %}selected{% endif %}>{{p}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit">Apply Filters</button>
        </div>
    </form>
    <div class="dashboard-cards">
      <div class="card-row">
        <div class="card"><div class="icon">ğŸ‘¨â€âš•ï¸</div><div class="label">Total Active Pharmacists</div><div class="value">{{total_active}}</div></div>
        <div class="card"><div class="icon">ğŸ’°</div><div class="label">Total Net Sales</div><div class="value">{{total_net_sales}}</div></div>
        <div class="card"><div class="icon">ğŸ§¾</div><div class="label">Total Net Invoices</div><div class="value">{{total_invoices}}</div></div>
        <div class="card"><div class="icon">ğŸ“Š</div><div class="label">Avg Daily Sales</div><div class="value">{{avg_daily_sales}}</div></div>
      </div>
      <div class="card-row">
        <div class="card"><div class="icon">ğŸ—“ï¸</div><div class="label">Avg Daily Transactions</div><div class="value">{{avg_daily_tx}}</div></div>
        <div class="card"><div class="icon">ğŸ“…</div><div class="label">Top Day Sales</div><div class="value">{{top_day}}<br><span class="weekday-label">{{top_day_weekday}}</span><br>{{top_day_val}}</div></div>
        <div class="card"><div class="icon">ğŸ“ˆ</div><div class="label">Top Day Invoices</div><div class="value">{{top_day_inv}}<br><span class="weekday-label">{{top_day_inv_weekday}}</span><br>{{top_day_inv_val}}</div></div>
        <div class="card"><div class="icon">ğŸ†</div><div class="label">Top Pharmacist Sales</div><div class="value">{{top_pharmacist}}<br>{{top_pharmacist_val}}</div></div>
      </div>
      <div class="card-row">
        <div class="card"><div class="icon">ğŸ¥‡</div><div class="label">Top Pharmacist Invoices</div><div class="value">{{top_pharmacist_inv}}<br>{{top_pharmacist_inv_val}}</div></div>
        <div class="card"><div class="icon">ğŸ’</div><div class="label">Top Invoice Value</div><div class="value">{{top_invoice_val}}<br>{{top_invoice_num}}<br>{{top_invoice_pharmacist}}</div></div>
      </div>
    </div>
    <div id="bar-chart"></div>
    <script>
        var graphs = JSON.parse('{{ graphJSON | tojson | safe }}');
        Plotly.newPlot('bar-chart', graphs.data, graphs.layout);
        
        function toggleFilter(id) {
            document.querySelectorAll('.filter-group').forEach(function(group) {
                if (group.id === id) {
                    group.classList.toggle('expanded');
                } else {
                    group.classList.remove('expanded');
                }
            });
        }
        // Collapse filter after choosing an option, but do not clear selection
        document.querySelectorAll('.filter-body select').forEach(function(select) {
            select.addEventListener('change', function(e) {
                var group = this.closest('.filter-group');
                if (group) group.classList.remove('expanded');
            });
        });
        // Expand first filter by default
        document.addEventListener('DOMContentLoaded', function() {
            var first = document.querySelector('.filter-group');
            if (first) first.classList.add('expanded');
            // Attach collapse on change after DOM is ready
            document.querySelectorAll('.filter-body select').forEach(function(select) {
                select.addEventListener('change', function(e) {
                    var group = this.closest('.filter-group');
                    if (group) group.classList.remove('expanded');
                });
            });
        });
    </script>
</body>
</html>
